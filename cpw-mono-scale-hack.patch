From d9ecab07bb6558a1c8da9a2d71a55ebd57c321c6 Mon Sep 17 00:00:00 2001
From: cpw <cpw+github@weeksfamily.ca>
Date: Mon, 20 Apr 2020 12:18:58 -0400
Subject: [PATCH] Some fixes to let aurora work well on mono

---
 mcs/class/System.Drawing/System.Drawing/Image.cs         | 2 +-
 .../System.Windows.Forms/ContainerControl.cs             | 3 +++
 .../System.Windows.Forms/System.Windows.Forms/ListBox.cs | 7 +++++--
 .../System.Windows.Forms/System.Windows.Forms/Theme.cs   | 9 +++++++--
 4 files changed, 16 insertions(+), 5 deletions(-)

diff --git a/mcs/class/System.Drawing/System.Drawing/Image.cs b/mcs/class/System.Drawing/System.Drawing/Image.cs
index 30ae8311b27..e03afab3fcb 100644
--- a/mcs/class/System.Drawing/System.Drawing/Image.cs
+++ b/mcs/class/System.Drawing/System.Drawing/Image.cs
@@ -98,7 +98,7 @@ void ISerializable.GetObjectData (SerializationInfo si, StreamingContext context
 	// static
 	public static Image FromFile(string filename)
 	{
-		return FromFile (filename, false);
+		return FromFile (filename.Replace('\\','/'), false);
 	}
 	
 	public static Image FromFile(string filename, bool useEmbeddedColorManagement)
diff --git a/mcs/class/System.Windows.Forms/System.Windows.Forms/ContainerControl.cs b/mcs/class/System.Windows.Forms/System.Windows.Forms/ContainerControl.cs
index 5f800f576e5..3a65d54196a 100644
--- a/mcs/class/System.Windows.Forms/System.Windows.Forms/ContainerControl.cs
+++ b/mcs/class/System.Windows.Forms/System.Windows.Forms/ContainerControl.cs
@@ -348,6 +348,9 @@ internal void SendControlFocus (Control c)
 
 		protected SizeF AutoScaleFactor {
 			get {
+				if (Environment.GetEnvironmentVariable("SCALEHACKX")!=null) {
+					return new SizeF(float.Parse(Environment.GetEnvironmentVariable("SCALEHACKX")), float.Parse(Environment.GetEnvironmentVariable("SCALEHACKY")??"1"));
+				}
 				if (auto_scale_dimensions.IsEmpty)
 					return new SizeF (1f, 1f);
 
diff --git a/mcs/class/System.Windows.Forms/System.Windows.Forms/ListBox.cs b/mcs/class/System.Windows.Forms/System.Windows.Forms/ListBox.cs
index fbc74eed38d..5cc84b5ad2a 100644
--- a/mcs/class/System.Windows.Forms/System.Windows.Forms/ListBox.cs
+++ b/mcs/class/System.Windows.Forms/System.Windows.Forms/ListBox.cs
@@ -517,8 +517,11 @@ internal void OnUIAFocusedItemChangedEvent ()
 				if (value < -1 || value >= Items.Count)
 					throw new ArgumentOutOfRangeException ("Index of out range");
 
-				if (SelectionMode == SelectionMode.None)
-					throw new ArgumentException ("cannot call this method if SelectionMode is SelectionMode.None");
+				if (SelectionMode == SelectionMode.None) {
+					selected_indices.Clear ();
+					return;
+					//throw new ArgumentException ("cannot call this method if SelectionMode is SelectionMode.None");
+				}
 
 				if (value == -1)
 					selected_indices.Clear ();
diff --git a/mcs/class/System.Windows.Forms/System.Windows.Forms/Theme.cs b/mcs/class/System.Windows.Forms/System.Windows.Forms/Theme.cs
index b4294792db9..4c8612b465c 100644
--- a/mcs/class/System.Windows.Forms/System.Windows.Forms/Theme.cs
+++ b/mcs/class/System.Windows.Forms/System.Windows.Forms/Theme.cs
@@ -360,9 +360,14 @@ private void SetSystemColors (KnownColor kc, Color value)
 		}
 
 		public virtual Font DefaultFont {
-			get { return default_font ?? (default_font = SystemFonts.DefaultFont); }
+			get { return default_font ?? (default_font = GetDefaultFont()); }
 		}
 
+		private static Font GetDefaultFont() {
+			return new Font(Environment.GetEnvironmentVariable("FONT_NAME") ?? "Nimbus Sans",
+			float.Parse(Environment.GetEnvironmentVariable("FONT_SIZE") ?? "8"),
+			(FontStyle)Enum.Parse(typeof(FontStyle), Environment.GetEnvironmentVariable("FONT_STYLE") ?? "Regular"));
+		}
 		public virtual Color DefaultWindowBackColor {
 			get { return defaultWindowBackColor; }
 		}
@@ -506,7 +511,7 @@ public virtual void SetColor (XplatUIWin32.GetSysColorIndex idx, Color color)
 
 		public virtual Font MenuFont {
 			get {
-				return default_font ?? (default_font = SystemFonts.DefaultFont);
+				return default_font ?? (default_font = GetDefaultFont());
 			}
 		}
 
-- 
2.25.1

